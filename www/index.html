<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./assets/bootstrap.min.css">
</head>
<body>

<!-- This starts the NetworkTables websocket, it can be accessed from multiple
     pages simultaneously -->
<script src="./assets/networktables.js"></script>

<!-- Obviously, you will want to copy this file locally in a real 
     dashboard, as the Driver Station won't have internet access -->
<script src="./assets/jquery-3.3.1.min.js"></script>

<script src="./assets/popper.min.js"></script>

<script src="./assets/bootstrap.min.js"></script>

<script src="./assets/Handynetworktables.js"></script>

<div class="row">
    <div class="col-12">
        <div class="progress">
            <div id="percent" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
        </div>
    </div>
    <div class="col-12">
	    <h1 id="battery">100%</h1><h2>X: <span class="__SmartDashboard__Turn text-danger"></span>
		    Y: <span class="__SmartDashboard__Throttle text-info"></span>
	    	Q: <span id="turnQ" class="text-primary"></span></h2>
        <img id="connected-icon" src="assets/connected.png" height="40px" class="d-none"/>
           Robot: <span id="robotstate">Unknown state</span> @ <span id="robotAddress">disconnected</span>
    </div>
    <div class="col-12">
	    <h2 class="text-danger">EXCEPTION - <span class="__SmartDashboard__Vision__frame"></span></h2>
    </div>
</div>
<!-- uncomment this is you want to use included utility functions that
     implement common functionality that you might find useful. Requires
     that d3.js and jQuery are included first -->
<!-- <script src="/networktables/utils.js"></script> -->
<svg id="robot">

</svg>

<div id="field">
    <img src="field.jpg" width="50%" style="border:3px dotted black; display: none;">

</div>
<img src="http://frcvision.local:1181/stream.mjpg">
<div>
    <h3 class="__SmartDashboard__Vision__approxL"></h3>
    <h4 class="__SmartDashboard__Vision__tapeYaw"></h4>
    <h4>PNP Success: <span class="__SmartDashboard__Vision__PNPsuccess"></span></h4>
    <h4>RVEC: <span class="__SmartDashboard__Vision__rvec"></span></h4>
    <h4>TVEC: <span class="__SmartDashboard__Vision_tvec"></span></h4>

    <img src="wifi.svg" width="25px">
    NetworkTables websocket: <span id="connectstate">Unknown state</span><br/>

</div>
<hr/>

<table id="nt" border=1>
    <tbody></tbody>
</table>


<script>
    $(document).ready(function () {

        // sets a function that will be called when the websocket connects/disconnects
        NetworkTables.addWsConnectionListener(onNetworkTablesConnection, true);

        // sets a function that will be called when the robot connects/disconnects
        NetworkTables.addRobotConnectionListener(onRobotConnection, true);

        // sets a function that will be called when any NetworkTables key/value changes
        NetworkTables.addGlobalListener(onValueChanged, true);
    });


    function onRobotConnection(connected) {
        $('#robotstate').text(connected ? "Connected!" : "Disconnected");
        $('#robotAddress').text(connected ? NetworkTables.getRobotAddress() : "disconnected");
        //to do show connection logo
        if (connected){
             $('#connected-icon').removeClass('d-none');
        } else {
              $('#connected-icon').addClass('d-none');
        }

    }

    function onNetworkTablesConnection(connected) {

        if (connected) {
            $("#connectstate").text("Connected!");


        } else {
            $("#connectstate").text("Disconnected!");
        }
    }

    function onValueChanged(key, value, isNew) {

        // Replace all forward slashes with double underscores
        var target_class = key.replace(/\//g, '__');

        $('.' + target_class).text(value);
        updateBattery(key, value);
	updateQ(key, value);
        oldValueChanged(key, value, isNew);
    }

    function updateBattery(key, value) {
        if (key === '/SmartDashboard/Battery_Voltage') {
            var voltage = parseFloat(value);
            var normalizedVoltage = voltage - 8;
            var percent = parseInt(normalizedVoltage * 20);
            $("#battery").text(percent);
            $("#percent").width(percent + "%")
        }
    }

	function updateQ(key, value) {
		if (key === '/SmartDashboard/Turn') {
			var turn = value;
			var q = Math.sin(turn * Math.PI/2);
			$('#turnQ').text(q);
		}
	}

    function oldValueChanged(key, value, isNew) {

        if (isNew) {
            var tr = $('<tr></tr>').appendTo($('#nt > tbody:last'));
            $('<td></td>').text(key).appendTo(tr);
            $('<td></td>').attr('id', NetworkTables.keyToId(key))
                .text(value)
                .appendTo(tr);
        } else {

            // similarly, use keySelector to convert the key to a valid jQuery
            // selector. This should work for class names also, not just for ids
            $('#' + NetworkTables.keySelector(key)).text(value);
        }
        if (key == "/SmartDashboard/Robot_State_X") {
            x = value + 100;
        }
        if (key == "/SmartDashboard/Robot_State_Y") {
            y = value + 100;
        }
        if (key == "/SmartDashboard/Robot_State_R") {
            rotation = -value;
        }

}

</script>
</body>
</html>
